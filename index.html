<script>
    // 設定値
    const FREE_LIMIT = 5;
    let userApiKey = ""; 

    // 画面切り替え
    function showStep(id) {
        const steps = ['step-login', 'step-s1', 'pr-step1', 'pr-step2', 'pr-step3', 'step-result', 'step-api-setting'];
        steps.forEach(s => {
            const el = document.getElementById(s);
            if(el) el.classList.add('hidden');
        });
        document.getElementById(id).classList.remove('hidden');
    }

    // 使用回数のカウント
    function getUsageCount() {
        return parseInt(localStorage.getItem('usageCount') || '0');
    }

    function incrementUsage() {
        const count = getUsageCount() + 1;
        localStorage.setItem('usageCount', count);
        return count;
    }

    // Gemini API 呼び出しメインロジック
    async function callGemini(prompt) {
        const count = getUsageCount();
        let apiKey = "";

        if (count < FREE_LIMIT) {
            apiKey = AIzaSyBgJNO7o9oov4ZpsRYxbhs0DFGoYZMEGJw; // ★ここにShigeruさんのAPIキーを貼ってください
        } else {
            apiKey = localStorage.getItem('userCustomApiKey');
            if (!apiKey) {
                alert("お試し回数を超えました。ご自身のAPIキーを設定してください。");
                showStep('step-api-setting');
                return;
            }
        }

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            if (!response.ok) throw new Error('API制限');
            
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;

        } catch (error) {
            return "ジェミニが疲れ果てました…。少し時間を置いてから、また声をかけてくださいね。";
        }
    }

    // 自己PR生成ボタン押下時
    async function generatePR() {
        const title = document.getElementById('input-title').value;
        if (!title) { alert('課題のタイトルは必須ですよ！'); return; }

        // プロンプト作成（設計書のルールを注入）
        const name = localStorage.getItem('userName');
        const inputs = {
            q1: document.getElementById('input1').value,
            q6: document.getElementById('input6').value,
            q10: document.getElementById('input10').value,
            q13: document.getElementById('input13')?.value || "" 
            // ...他の入力も同様に収集
        };

        const systemPrompt = `
        あなたは優秀なキャリアコンサルタントです。
        ユーザー名: ${name}
        課題: ${title}
        
        以下の「作成ルール」を厳守して自己PRを作成してください。
        1. 「です・ます」調で、結論先行で書くこと。
        2. 「私」という言葉を多用しない。
        3. 問題克服のプロセスにおける苦労や心情を、入力内容から類推して深掘りすること。
        4. 他者からの褒め言葉があればエピソードに組み込むこと。
        5. 約400文字程度でまとめること。

        入力内容:
        - 力を入れたこと: ${inputs.q1}
        - 苦労した点: ${inputs.q6}
        - 学び: ${inputs.q10}
        `;

        // ローディング表示（仮）
        alert("AIが作成中です。しばらくお待ちください...");
        
        const result = await callGemini(systemPrompt);
        incrementUsage();
        
        // 結果表示画面へ（この画面は次のステップで作成しましょう）
        alert("【生成結果】\n" + result);
        showStep('step-s1'); 
    }
</script>
